<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inponow Web Chat</title>
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <script src="/jsjq/jquery.min.js" charset="utf-8"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/bootstrap.js"></script>
  <script src="/socket.io/socket.io.js" charset="utf-8"></script>
  <style media="screen">
    @font-face {
      font-family: 'sans-bold';
      src: url('/font/OpenSans-Bold.ttf');
    }

    @font-face {
      font-family: 'sans';
      src: url('/font/OpenSans-Regular.ttf');
    }

    body{
      font-family: 'sans';
    }

    .shadow {
      /* box-shadow: rgba(0, 0, 0, 0.08) 0px 4px 12px !important; */
      box-shadow: rgba(255, 255, 255, 0.2) 0px 0px 0px 1px inset, rgba(0, 0, 0, 0.1) 0px 0px 0px 1px !important;
      border-radius: 7.2px;
    }

    .bg-blue {
      background: #00CF68 !important;
      color: white;
      width: 100% !important;
      border-color: #00CF68;
    }

    a{
      color:#011f32 !important;
      font-weight: bold;
    }

    .bg-yellow {
      color: #fff;
      border-color: transparent;
      background: #262626 !important;
    }

    .tr_contact:hover{
      background:rgba(0, 207, 104, 0.11);
    }

    .btn-simple-cs{
      border:1px solid #00CF68;width:100%;color:#20995d;
    }

    .input-info{
      border:none;cursor: pointer;padding:0;
    }
  </style>
</head>

<body>
  <div class="container">
    <br>
    <div class="">
      <div class="row">
        <div class="col-md-12">
          <h3 style="float:left">Inponow <span style="color:#00CF68;font-family: 'sans-bold';">Web Chat</span></h3>
          <a href="/logout" style="float:right;font-family: 'sans-bold';" class="mt-2">üöÄ Logout</a>
        </div>
        <div class="col-md-12 mt-3">
          <% if(flash == 1){ %>
          <div class="alert shadow alert-dismissible fade show alert__" style="background:#1ab065;color:#e3e3e3;border:none" role="alert">
            Login <b>Success !</b>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <% } %>
          <div class="notification_area">

          </div>
            <div class="alert shadow" style="background:rgba(0, 207, 104, 0.11);color:#00b75c">
            <span style="font-family: 'sans-bold'">Hello,</span> <%= user_login.name %> üòÄ
          </div>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-md-12">
          <ul class="nav nav-tabs" id="myTab" role="tablist" style="font-family: 'sans-bold'">
            <li class="nav-item" role="presentation">
              <a class="nav-link active" id="home-tab" onclick="save_tab('home-tab')" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Your Chat</a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="contact-tab" onclick="save_tab('contact-tab')" data-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="false">My Contact</a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="profile-tab" onclick="save_tab('profile-tab')" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Profile</a>
            </li>
          </ul>
        </div>
      </div>
      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
          <div class="row">
            <div class="col-md-12">
              <table class="table table-borderless table-o mt-3 table_chat" style="width: 100%;border-radius:5px;">
                <tbody>
                  <% chat_list.forEach((item, i) => { %>
                  <tr style="border-bottom:1px solid #cdcdcd;" class="tr_contact" onclick="click_to_chat('/index/<%= item.id_friend %>')">
                    <td style="width:65px"><img src="<%=item.img_profile != '' ? item.img_profile : '/img/default.png' %>" style="width:55px;height:55px;border-radius:50%" alt=""> </td>
                    <td style="vertical-align:middle"> <b><%= item.name %></b>
                      <br>
                      <small> <span class="sender_chat_<%= item.username %>"><%= item.user_id == user_login.id_user ? 'You' : item.name %></span> : <span class="target_<%= item.username  %>"><%= item.message  %></span> </small>
                    </td>
                    <td style="vertical-align:top;float:right"> <small class="target_time_<%= item.username  %>"><%= item.time_chat %></small> </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
          <div class="row list__">
            <div class="col-md-12">
              <br>
            </div>
            <div class="col-md-10">
              <input type="text" class="form-control" oninput="searhContact(this)" style="width:100%" placeholder="Filter your friend name..." name="" value="">
            </div>
            <div class="col-md-2">
              <button type="button" class="btn shadow nbr0012 btn-simple-cs" name="button_add_friend">‚ûï Find Friend</button>
            </div>
            <div class="col-md-12">
              <table class="table table-borderless table-o mt-3 friend_list" style="width: 100%;border-radius:5px;">
                <tbody>
                  <% items.forEach((item, i) => { %>
                  <tr style="border-bottom:1px solid #cdcdcd;" class="tr_contact" onclick="click_to_chat('/index/<%= item.id_user %>')">
                    <td style="width:65px"><img src="<%=item.img_profile != '' ? item.img_profile : '/img/default.png' %>" style="width:55px;height:55px;border-radius:50%" alt=""> </td>
                    <td style="vertical-align:middle"><%= item.name %></td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="add__ " style="display:none;background:rgba(0, 207, 104, 0.11);border-radius:10px;">
                <div class="row mt-3 p-3">
                  <div class="col-md-12">
                    <h5 class="float-left font-weight-bold">Find Friend</h5>
                    <button type="button" class="float-right" style="background:transparent;border:0;color:#00CF68;font-family:'sans-bold';" name="button_back">üèÑüèΩ Back</button>
                  </div>
                  <div class="col-md-10 mt-3">
                    <input type="text" id="username__" class="form-control" autocomplete="off" placeholder="Search By Username..." value="">
                  </div>
                  <div class="col-md-2">
                    <button type="button" class="btn shadow mt-3 find__ btn-simple-cs" style="" name="button">üîç Find</button>
                  </div>
                  <div class="col-md-12 find_area__">

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
          <div class="row">
            <div class="col-md-12">
              <br>
              <div class="p-5 mb-2" style="border-radius:10px;background:rgba(0, 207, 104, 0.11)">
                <center>
                  <img src="<%= img_profile != '' ? img_profile : '/img/default.png' %>" style="width:250px;border-radius:10px" title="click to change your photo" alt=""  data-toggle="modal" data-target="#edit_profil">
                </center>
              </div>
              <table style="width:100%">
                <tr style="border-bottom:1px solid #cdcdcd;">
                  <td>Name</td>
                </tr>
                <tr>
                  <td class="pt-2">
                    <input type="text" class="form-control input-info" name="" value="<%= user_login.name %>">
                  </td>
                </tr>
                <tr style="border-bottom:1px solid #cdcdcd;">
                  <td class="pt-3">Information</td>
                </tr>
                <tr>
                  <td class="pt-2">
                    <input type="text" class="form-control input-info" name="" value="Ex : I'm Actually Superman, But don't tell anyone.">
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>
      <footer class="row mt-4">
        <div class="col-md-12" >
          <div style="border-top:1px solid #00b75c;">
            <div class="pt-3 pb-3 float-right">
              ¬© Copyright 2021 Aldi Pradana
            </div>
          </div>
        </div>
      </footer>
    </div>

  </div>

  <div class="position-fixed bottom-0 right-0 p-3" style="z-index: 5; right: 0; bottom: 0;">
    <div id="liveToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true" data-delay="3000">
      <div class="toast-header">
        <strong class="mr-auto">Inponow <span style="color:#00CF68;font-family: 'sans-bold';">Web Chat</span></strong>
        <small>Now</small>
        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="toast-body">
         Username Form Input Can't Be Empty, Please Type..
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="edit_profil" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form action="/uploadpp" method="post" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Edit photo profile</h5>
        </div>
        <div class="modal-body">
            <div class="form-group">
              <!-- <label for="exampleFormControlFile1">Choose Photo</label> -->
              <input name="img" type="file" class="form-control-file" id="FormControlFile1" accept="image/*">
              <img src="<%= img_profile %>" id="preview-profile" class="mt-2" alt="" style="width:100%">
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="submit" class="btn" style="background: #00CF68 !important;color: white;">Save changes</button>
        </div>
        </form>
      </div>
    </div>
  </div>

  <script type="text/javascript">

  $('#FormControlFile1').on('change', function() {
    let reader = new FileReader()
    reader.onload = function(){
      var output = $('#preview-profile')[0]
      output.src = reader.result
    };
    reader.readAsDataURL(event.target.files[0])
  })

    function click_to_chat(n) {
      console.log(n);
      location.replace(n);
    }

    function isStorageExist() {
       if(typeof(Storage) === undefined){
           console.log("Browser kamu tidak mendukung local storage");
           return false
       }
       return true;
    }

    function ws(master) {
      localStorage.setItem('INPONOW_WEB_CHAT', JSON.stringify(master))
    }

    function save_tab(n) {
      let data = {
        'tab_opened' : n
      }
      ws(data);
      // console.log(JSON.parse(localStorage.getItem('INPONOW_WEB_CHAT')), 'ini web storage');
    }

    $(document).ready(function() {
      setTimeout(function() {
        $('.alert__').fadeOut();
      }, 3000);

      if (isStorageExist()) {
        let tab = JSON.parse(localStorage.getItem('INPONOW_WEB_CHAT'))
        if (tab != null) {
          if (tab.tab_opened == 'contact-tab') {
            $(`#home-tab`).removeClass('active').removeClass('.show');
            $(`#home`).removeClass('active').removeClass('.show');
            $(`#contact-tab`).addClass('active').addClass('show');
            $(`#contact`).addClass('active').addClass('show');
          }else if (tab.tab_opened == 'profile-tab') {
            $(`#home-tab`).removeClass('active').removeClass('.show');
            $(`#home`).removeClass('active').removeClass('.show');
            $(`#profile-tab`).addClass('active').addClass('show');
            $(`#profile`).addClass('active').addClass('show');
          }
        }
      }
    });

    $('button[name="button_add_friend"]').on('click', function() {
      $('.add__').show();
      $('.list__').hide();
    });

    $('button[name="button_back"]').on('click', function() {
      $('.add__').hide();
      $('.list__').show();
    });

    $('.find__').on('click', () => {
      let val = $('#username__').val();
      if (val != '') {
        $.ajax({
          url: "/find",
          type: 'POST',
          cache: false,
          // dataType: 'JSON',
          data: {
            username: val,
          },
          beforeSend: function() {
            $('.find_area__').html(`<center class="mt-5"><h2>üèÑ</h2>Loading..</center>`);
          },
          success: function(result) {
            if (result != 0) {
              $('.find_area__').html(result);
            } else {
              $('.find_area__').html('<center class="mt-5"><h2>üò¢</h2>Username Not Found !</center>');
            }
          },
          error: function(XMLHttpRequest, textStatus, errorThrown) {
            console.error();
          }
        })
      }else {
        $('#liveToast').toast('show')
      }
    })

    const add_friend = (id_) => {
      let tampung_sementara = [];
      $(`tr[row-id="${id_}"] td`).each((i,v) =>{
        if (i !== 3) {
          tampung_sementara.push($(v).text());
        }
      })

      $('.find_area__').html(`<center class="mt-5"><h2>üèÑ</h2>Sedang Menambahkan Teman..</center>`);

      $.ajax({
        url: "/cek_friend",
        type: 'POST',
        cache: false,
        dataType: 'JSON',
        data: {
          id_friend: id_
        },
        success: function(result_) {
          console.log(result_);
          if (result_ == 1) {

            $.ajax({
              url: "/add_friend",
              type: 'POST',
              cache: false,
              dataType: 'JSON',
              data: {
                id_friend: id_,
                id_group_chat: `<%= user_login.username %>_${tampung_sementara[1]}`
              },
              success: function(result) {
                if (result.success == 1) {
                  let count_ = $('.friend_list tbody tr').length;
                  $('.friend_list tbody').append(`<tr style="border-bottom:1px solid #cdcdcd;" class="tr_contact" onclick="click_to_chat('/index/${id_}')">
                                                    <td style="vertical-align:middle">${tampung_sementara[2]}</td>
                                                  </tr>`);
                  $('.find_area__').html(`<center class="mt-5"><h2>üèÑ</h2>${tampung_sementara[2]} berhasil ditambahkan</center>`);
                  setTimeout(function () {
                    $('.find_area__').html(``);
                  }, 579);
                }else {
                  $('.find_area__').html(`<center class="mt-5"><h2>üèÑ</h2>${tampung_sementara[2]} </center>`);
                }
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.error();
              }
            })


          }else {
            $('.find_area__').html(`<center class="mt-5"><h2>üèÑ</h2>${tampung_sementara[2]} telah menjadi teman anda.</center>`);
          }

        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          console.error();
        }
      })

    }

    $(function() {
      let socket = io.connect()
      socket.on(`notification_<%= user_login.id_user %>`, function(data) {
        $('.notification_area').html(`<div class="alert shadow alert-dismissible fade show" style="background:rgba(0, 207, 104, 0.11);color:#00b75c" role="alert">
          New Message From <b style="text-transform:capitalize">${data.sender}</b> ~ "${data.msg}"
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>`);
        // console.log($(`.target_${data.sender}`).text(), 'cek notif');
        if ($(`.target_${data.sender}`).text() == '') {
          let new_message = `<tr style="border-bottom:1px solid #cdcdcd;" class="tr_contact" onclick="click_to_chat('/index/${data.id_receiver}')">
                              <td style="vertical-align:middle">${data.name}
                                <br>
                                <small>${data.name} : <span class="target_${data.sender}">${data.msg}</span> </small>
                              </td>
                              <td style="vertical-align:top;float:right"> <small class="target_time_${data.sender}">${data.time}</small> </td>
                            </tr>`;
          $('.table_chat tbody').append(new_message);
        }else {
          $(`.target_${data.sender}`).text(data.msg);
          $(`.target_time_${data.sender}`).text(data.time);
          $(`.sender_chat_${data.sender}`).text(data.name);
        }

    })


    })

    function searhContact(th) {
      var $rows = $('.friend_list tr');
      $(th).keyup(function() {
          var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();

          $rows.show().filter(function() {
              var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
              return !~text.indexOf(val);
          }).hide();
      });
    }

    function respo() {
      if ($(window).width() > 768) {
        $('.nbr0012').removeClass('mt-2');
      } else {
        $('.nbr0012').addClass('mt-2');
      }
    }
    respo();
    $(window).resize(function() {
      respo();
    })


  </script>
</body>

</html>
