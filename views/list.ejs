<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inponow Web Chat</title>
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <script src="/js/jquery.min.js" charset="utf-8"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/socket.io/socket.io.js" charset="utf-8"></script>
  <style media="screen">
    .shadow {
      box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 3px 1px -2px rgba(0, 0, 0, 0.12), 0 1px 5px 0 rgba(0, 0, 0, 0.20) !important;
      border-radius: 7.2px;
    }

    .bg-blue {
      background: #00A3FF !important;
      color: white;
      border-color: #00a3ff;
    }

    .bg-yellow {
      color: #000;
      border-color: transparent;
      background: #ffb800 !important;
    }
  </style>
</head>

<body>
  <div class="container">
    <br>
    <div class="">
      <div class="row">
        <div class="col-md-8">
          <h3>Inponow Web Message</h3>
        </div>
        <div class="col-md-4">
          <a href="/logout" class="btn btn-success float-right bg-yellow shadow">🚀 Logout</a>
        </div>
        <div class="col-md-12 mt-3">
          <% if(flash == 1){ %>
          <div class="alert alert-info alert-dismissible fade show alert__" role="alert">
            <strong style="font-size:13px">Login Berhasil !</strong>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <% } %>
          <div class="alert bg-dark text-white shadow" role="alert">
            <strong>Hello,</strong> <%= user_login.name %> 😀
          </div>
        </div>
      </div>
      <div class="row list__">
        <div class="col-md-12">
          <br>
        </div>
        <div class="col-md-6">
          <h5 class="pt-1">Friend List</h5>
        </div>
        <div class="col-md-6">
          <button type="button" class="btn bg-yellow shadow float-right" name="button_add_friend">🕺🏽 Add Friend</button>
        </div>
        <div class="col-md-12">
          <table class="table table-borderless mt-3 shadow friend_list" style="width: 100%;border-radius:5px;">
            <thead class="">
              <tr style="border-bottom:1px solid #e3e3e3">
                <th style="width:7%;text-align:center">No</th>
                <th>Name</th>
                <th style="width:20%"> </th>
              </tr>
            </thead>
            <tbody>
              <% items.forEach((item, i) => { %>
              <tr style="">
                <td style="text-align:center"><%= Number(i)+1 %></td>
                <td style="vertical-align:middle"><%= item.name %></td>
                <td style="vertical-align:middle;text-align:center"> <a href="/index/<%= item.id_user %>" class="btn bg-blue shadow">👋 Chat</a> </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
      <div class=" row add__ mt-4" style="display:none">
        <div class="col-md-6">
          <h5 class="pt-1">Find Friend</h5>
        </div>
        <div class="col-md-6">
          <button type="button" class="btn bg-yellow shadow float-right" name="button_back">🏄🏽 Back</button>
        </div>
        <div class="col-md-10 mt-3">
          <input type="text" id="username__" class="form-control" placeholder="Search By Username..." value="" style="border-color: transparent;width:100%;border-radius: 7.5px;box-shadow: 0 1px 1px 0 rgba(213, 213, 213, 0.68)">
        </div>
        <div class="col-md-2">
          <button type="button" style="width:100%" class="btn bg-yellow shadow mt-3 find__" name="button">Find</button>
        </div>
        <div class="col-md-12 find_area__">

        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript">
    $(document).ready(function() {
      setTimeout(function() {
        $('.alert__').fadeOut();
      }, 2000);
    });

    $('button[name="button_add_friend"]').on('click', function() {
      $('.add__').show();
      $('.list__').hide();
    });

    $('button[name="button_back"]').on('click', function() {
      $('.add__').hide();
      $('.list__').show();
    });

    $('.find__').on('click', () => {
      $.ajax({
        url: "/find",
        type: 'POST',
        cache: false,
        // dataType: 'JSON',
        data: {
          username: $('#username__').val(),
        },
        beforeSend: function() {
          $('.find_area__').html(`<center class="mt-5"><h2>🏄</h2>Loading..</center>`);
        },
        success: function(result) {
          if (result != 0) {
            $('.find_area__').html(result);
          } else {
            $('.find_area__').html('<center class="mt-5"><h2>😢</h2>Username Not Found !</center>');
          }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          console.error();
        }
      })
    })

    const add_friend = (id_) => {
      let tampung_sementara = [];
      $(`tr[row-id="${id_}"] td`).each((i,v) =>{
        if (i !== 3) {
          tampung_sementara.push($(v).text());
        }
      })

      $('.find_area__').html(`<center class="mt-5"><h2>🏄</h2>Sedang Menambahkan Teman..</center>`);

      $.ajax({
        url: "/cek_friend",
        type: 'POST',
        cache: false,
        dataType: 'JSON',
        data: {
          id_friend: id_
        },
        success: function(result_) {
          console.log(result_);
          if (result_== 1) {


            $.ajax({
              url: "/add_friend",
              type: 'POST',
              cache: false,
              dataType: 'JSON',
              data: {
                id_friend: id_,
                id_group_chat: `<%= user_login.username %>_${tampung_sementara[1]}`
              },
              success: function(result) {
                if (result.success == 1) {
                  let count_ = $('.friend_list tbody tr').length;
                  $('.friend_list tbody').append(`<tr style="">
                                                    <td style="text-align:center">${Number(count_) + 1}</td>
                                                    <td style="vertical-align:middle">${tampung_sementara[2]}</td>
                                                    <td style="vertical-align:middle;text-align:center"> <a href="/index/${id_}" class="btn bg-blue shadow">👋 Chat</a> </td>
                                                  </tr>`);
                  $('.find_area__').html(`<center class="mt-5"><h2>🏄</h2>${tampung_sementara[2]} berhasil ditambahkan</center>`);
                  setTimeout(function () {
                    $('.find_area__').html(``);
                  }, 579);
                }else {
                  $('.find_area__').html(`<center class="mt-5"><h2>🏄</h2>${tampung_sementara[2]} </center>`);
                }
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.error();
              }
            })


          }else {
            $('.find_area__').html(`<center class="mt-5"><h2>🏄</h2>${tampung_sementara[2]} telah menjadi teman anda.</center>`);
          }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          console.error();
        }
      })

    }

    // function chat_to(my_friend) {
    //   let socket = io.connect();
    //   socket.emit('myprivatechatroom', {
    //     my_friend: my_friend
    //   });
    //   alert('mencoba mengirim...')
    // }
  </script>
</body>

</html>
